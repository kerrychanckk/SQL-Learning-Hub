<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple SQL Sandbox</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .sql-editor { font-family: 'Courier New', Courier, monospace; font-size: 14px; }
        #results-container th, #results-container td { white-space: nowrap; }
        /* Styles for the accordion */
        details > summary {
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            background-color: #f1f5f9;
            border-radius: 0.375rem;
            font-weight: 600;
            margin-top: 0.5rem;
            transition: background-color 0.2s ease-in-out;
        }
        details > summary:hover {
            background-color: #e2e8f0;
        }
        details[open] > summary {
            background-color: #e2e8f0;
        }
        .question-list {
            padding-left: 1rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }
        .question-list li {
            padding: 0.3rem;
            cursor: pointer;
            border-radius: 0.25rem;
        }
        .question-list li:hover {
            background-color: #f0f9ff;
            color: #0284c7;
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Main Application UI -->
    <div id="app-container" class="h-screen flex flex-col">
        <header class="bg-white border-b border-slate-200 p-3 flex justify-between items-center shadow-sm">
            <h1 class="text-xl font-bold text-slate-800"><span class="text-sky-500">SQL</span> Sandbox for Students</h1>
            <button id="reset-db-btn" class="bg-red-500 text-white font-semibold text-sm py-2 px-4 rounded-lg hover:bg-red-600 transition shadow">Reset Database</button>
        </header>
        
        <main class="flex-grow flex flex-col md:flex-row overflow-hidden">
            <aside class="w-full md:w-1/4 bg-white border-r border-slate-200 p-4 flex flex-col overflow-y-auto">
                <div class="mb-4">
                    <details>
                        <summary>Database Schema</summary>
                        <div class="text-xs mt-2 p-3 bg-slate-50 rounded-lg font-mono text-slate-600 space-y-3">
                            <div>
                                <p class="font-semibold text-slate-800">students</p>
                                <ul class="list-disc list-inside pl-2">
                                    <li><span class="font-semibold">student_id</span> INTEGER PRIMARY KEY</li>
                                    <li><span class="font-semibold">class</span> TEXT</li>
                                    <li><span class="font-semibold">no</span> INTEGER</li>
                                    <li><span class="font-semibold">last_name</span> TEXT</li>
                                    <li><span class="font-semibold">first_name</span> TEXT</li>
                                    <li><span class="font-semibold">gender</span> TEXT</li>
                                    <li><span class="font-semibold">dob</span> DATE</li>
                                    <li><span class="font-semibold">district</span> TEXT</li>
                                </ul>
                            </div>
                            <div>
                                <p class="font-semibold text-slate-800">subjects</p>
                                <ul class="list-disc list-inside pl-2">
                                    <li><span class="font-semibold">subject_code</span> TEXT PK</li>
                                    <li><span class="font-semibold">subject_name</span> TEXT</li>
                                </ul>
                            </div>
                            <div>
                                <p class="font-semibold text-slate-800">exams</p>
                                <ul class="list-disc list-inside pl-2">
                                    <li><span class="font-semibold">student_id</span> INTEGER</li>
                                    <li><span class="font-semibold">subject_code</span> TEXT FK</li>
                                    <li><span class="font-semibold">score</span> INTEGER</li>
                                </ul>
                            </div>
                        </div>
                    </details>
                </div>
                <div class="mb-4">
                    <details open>
                        <summary>Tables in Database</summary>
                        <ul id="tables-list" class="space-y-2 text-sm mt-2"></ul>
                    </details>
                </div>
                <div class="flex-grow">
                    <h2 class="text-lg font-semibold mb-2 border-b pb-2">SQL Challenges</h2>
                    
                    <!-- Level 1 -->
                    <details id="level-1">
                        <summary class="text-green-700 bg-green-100 hover:bg-green-200">Level 1: Beginner</summary>
                        <ol class="question-list list-decimal list-inside">
                            <!-- Select -->
                            <li data-sql="-- Show all columns and all records from the 'students' table.">List all students.</li>
                            <li data-sql="-- Show all subjects available.">List all subjects.</li>
                            <li data-sql="-- Display only the first name, last name, and class for every student.">Show student names and class.</li>
                            <!-- Where -->
                            <li data-sql="-- Find all students who are in class '4A'.">Find all students in class '4A'.</li>
                            <li data-sql="-- List all exams with a score greater than 95.">Find exams with scores > 95.</li>
                            <li data-sql="-- List all male students ('M').">List all male students.</li>
                            <li data-sql="-- Find the student with class number 15 in class '4C'.">Find student #15 in 4C.</li>
                            <!-- Order By -->
                            <li data-sql="-- List all students ordered by their last name alphabetically (A-Z).">List students by last name.</li>
                            <li data-sql="-- Show all exam scores, from the highest to the lowest.">List scores from highest to lowest.</li>
                            <li data-sql="-- List all students ordered by their date of birth (oldest first).">Order students by birthday.</li>
                        </ol>
                    </details>

                    <!-- Level 2 -->
                    <details id="level-2">
                        <summary class="text-yellow-700 bg-yellow-100 hover:bg-yellow-200">Level 2: Intermediate</summary>
                         <ol class="question-list list-decimal list-inside">
                            <!-- Joins (Updated for new schema) -->
                            <li data-sql="-- JOIN students and exams to show names and scores.&#10;SELECT s.first_name, s.last_name, e.score &#10;FROM students s &#10;JOIN exams e ON s.student_id = e.student_id;">Show student scores (Basic Join).</li>
                            <li data-sql="-- JOIN exams and subjects to show Subject Name instead of Code.&#10;SELECT sub.subject_name, e.score &#10;FROM exams e &#10;JOIN subjects sub ON e.subject_code = sub.subject_code;">Show scores with Subject Names.</li>
                            <li data-sql="-- Triple Join: Student Name, Subject Name, and Score.&#10;SELECT s.first_name, sub.subject_name, e.score&#10;FROM students s&#10;JOIN exams e ON s.student_id = e.student_id&#10;JOIN subjects sub ON e.subject_code = sub.subject_code;">Full Report (Triple Join).</li>
                            
                            <!-- Where with AND/OR/NOT -->
                            <li data-sql="-- Find all students in class '4C' who are female ('F').">Find female students in '4C'.</li>
                            <li data-sql="-- List all exams for Subject Code 'MATH' OR 'PHY'.">Find 'MATH' or 'PHY' exams.</li>
                            <li data-sql="-- List exam scores between 80 and 85 (inclusive).">Find scores between 80 and 85.</li>
                            <li data-sql="-- Find all male students in class '4A' OR '4C'.">Find male students in '4A' or '4C'.</li>
                            
                            <!-- Group By -->
                            <li data-sql="-- Count the number of students in each class.">Count students in each class.</li>
                            <li data-sql="-- Find the average score for each subject code.">Find the avg score per subject code.</li>
                            <li data-sql="-- Find the highest score achieved in each subject code.">Find the max score per subject.</li>
                        </ol>
                    </details>
                    
                    <!-- Level 3 -->
                    <details id="level-3">
                        <summary class="text-red-700 bg-red-100 hover:bg-red-200">Level 3: Advanced</summary>
                         <ol class="question-list list-decimal list-inside">
                             <!-- Advanced Joins & Filtering -->
                            <li data-sql="-- List the full name and date of birth for all students taking the 'ICT' exam (Subject Code 'ICT').">Find 'ICT' students' details.</li>
                            <li data-sql="-- Find male students from class '4A' born after June 1st, 2008.">Find '4A' males born after 2008-06-01.</li>
                            <li data-sql="-- Find exam scores in 'MATH' or 'ENG' that are below 50 OR above 95.">Find extreme 'MATH'/'ENG' scores.</li>
                            <li data-sql="-- List students whose last name is 'Lee' or 'Chan' AND live in the 'Sha Tin' district.">'Lee'/'Chan' students in 'Sha Tin'.</li>
                            
                            <!-- Subqueries -->
                            <li data-sql="-- Find students in class '4A', '4C', or '4D' using the IN operator.">Find students in 4A, 4C, or 4D.</li>
                            <li data-sql="-- List all students who do not take the 'ECON' exam. (Hint: NOT IN)">Find students who don't take 'ECON'.</li>
                            
                             <!-- Aggregates with Joins -->
                            <li data-sql="-- Find the average exam score for each subject NAME (requires join). Order by average score descending.&#10;SELECT sub.subject_name, AVG(e.score) as avg_score&#10;FROM exams e&#10;JOIN subjects sub ON e.subject_code = sub.subject_code&#10;GROUP BY sub.subject_name&#10;ORDER BY avg_score DESC;">Avg score per Subject Name.</li>
                            
                             <!-- Having -->
                            <li data-sql="-- List classes where the average 'MATH' score is above 72.">Classes with avg 'MATH' score > 72.</li>
                            <li data-sql="-- List student IDs and their average scores, but only for students with an average score > 85.">Students with avg score > 85.</li>
                         </ol>
                    </details>
                </div>
            </aside>
            <div class="w-full md:w-3/4 flex flex-col p-4 gap-4 bg-slate-50 overflow-y-auto">
                <div class="flex flex-col bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <label for="sql-editor" class="text-lg font-semibold mb-2 text-slate-700">SQL Command Editor</label>
                    <textarea id="sql-editor" class="sql-editor w-full h-32 p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="-- Click a question from the 'SQL Challenges' list to get started!"></textarea>
                    <div class="flex items-center justify-between mt-3">
                        <p class="text-xs text-slate-500">Tip: Use <kbd class="font-sans bg-slate-200 rounded px-1.5 py-0.5 border-b-2 border-slate-300">Ctrl+Enter</kbd> or <kbd class="font-sans bg-slate-200 rounded px-1.5 py-0.5 border-b-2 border-slate-300">Cmd+Enter</kbd> to run.</p>
                        <div>
                            <button id="save-db-btn" class="bg-emerald-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-emerald-600 shadow-sm">Save to Browser</button>
                            <button id="run-sql-btn" class="bg-sky-500 text-white font-bold py-2 px-8 rounded-lg hover:bg-sky-600 shadow-sm">Run SQL</button>
                        </div>
                    </div>
                </div>
                <div class="flex-grow flex flex-col bg-white p-4 rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <h2 class="text-lg font-semibold mb-2 text-slate-700">Results</h2>
                    <div id="message-area" class="mb-2 text-sm h-5"></div>
                    <div id="results-container" class="flex-grow overflow-auto"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // DOM Elements
        const runSqlBtn = document.getElementById('run-sql-btn');
        const saveDbBtn = document.getElementById('save-db-btn');
        const resetDbBtn = document.getElementById('reset-db-btn');
        const tablesList = document.getElementById('tables-list');
        const sqlEditor = document.getElementById('sql-editor');
        const messageArea = document.getElementById('message-area');
        const resultsContainer = document.getElementById('results-container');
        
        // App State
        let db;
        let SQL;
        const dbKey = 'sql_sandbox_local_db_v2'; // Changed key to force fresh DB for new schema

        // --- Database Initialization ---
        async function main() {
            try {
                SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}` });
                loadDatabase();
                setupQuestionListeners();
            } catch (err) {
                console.error("Failed to initialize SQL.js:", err);
                displayMessage("error", "Error: Could not load database engine. Check internet and refresh.");
            }
        }

        function registerCustomFunctions(database) {
            // Register YEAR(date_string)
            database.create_function("YEAR", (dateStr) => {
                if (!dateStr) return null;
                const d = new Date(dateStr);
                return isNaN(d.getTime()) ? null : d.getFullYear();
            });

            // Register MONTH(date_string)
            database.create_function("MONTH", (dateStr) => {
                if (!dateStr) return null;
                const d = new Date(dateStr);
                return isNaN(d.getTime()) ? null : d.getMonth() + 1;
            });

            // Register MONTHNAME(date_string)
            database.create_function("MONTHNAME", (dateStr) => {
                if (!dateStr) return null;
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) return null;
                return d.toLocaleString('default', { month: 'long' });
            });

            // Register WEEKDAY(date_string) - Returns 0=Sunday, 1=Monday...
            database.create_function("WEEKDAY", (dateStr) => {
                if (!dateStr) return null;
                const d = new Date(dateStr);
                return isNaN(d.getTime()) ? null : d.getDay();
            });
        }

        function loadDatabase() {
            const savedDb = localStorage.getItem(dbKey);
            if (savedDb) {
                try {
                    const dbArray = savedDb.split(',').map(Number);
                    db = new SQL.Database(new Uint8Array(dbArray));
                    registerCustomFunctions(db); // Register functions on load
                    displayMessage("success", "Loaded saved database from your browser.");
                } catch (e) {
                    console.error("Error loading DB from localStorage:", e);
                    localStorage.removeItem(dbKey); // Clear corrupted data
                    createNewDatabase();
                }
            } else {
                createNewDatabase();
            }
            updateTablesList();
        }
        
        function createNewDatabase() {
            db = new SQL.Database();
            registerCustomFunctions(db); // Register functions on create
            createSampleTables(db);
            displayMessage("success", "A new database with normalized tables ('students', 'subjects', 'exams') has been created.");
        }

        function createSampleTables(database) {
            try {
                // Drop old tables if they exist for a clean reset
                database.run(`DROP TABLE IF EXISTS students;`);
                database.run(`DROP TABLE IF EXISTS exams;`);
                database.run(`DROP TABLE IF EXISTS subjects;`);

                // Create new students table
                database.run(`
                    CREATE TABLE students (
                        student_id INTEGER PRIMARY KEY,
                        class TEXT,
                        no INTEGER,
                        last_name TEXT,
                        first_name TEXT,
                        gender TEXT,
                        dob DATE,
                        district TEXT
                    );
                `);

                // Create subjects table
                database.run(`
                    CREATE TABLE subjects (
                        subject_code TEXT PRIMARY KEY,
                        subject_name TEXT
                    );
                `);

                // Create new exams table with Subject Code
                database.run(`
                    CREATE TABLE exams (
                        student_id INTEGER,
                        subject_code TEXT,
                        score INTEGER,
                        FOREIGN KEY(student_id) REFERENCES students(student_id),
                        FOREIGN KEY(subject_code) REFERENCES subjects(subject_code)
                    );
                `);
                
                // Data Generation
                const lastNames = ['Chan', 'Lee', 'Wong', 'Cheung', 'Lau', 'Leung', 'Ho', 'Fung', 'Mak', 'Yip', 'Ng', 'Lam', 'Poon', 'Tang'];
                const maleFirstNames = ['Ka-Chun', 'Lok-Hang', 'Chi-Kin', 'Siu-Ming', 'Wai-Ho', 'Tsz-Fung', 'Man-Hin', 'Pak-Hei', 'Chun-Kit', 'Yat-Long'];
                const femaleFirstNames = ['Wing-Yan', 'Tsz-Ching', 'Hiu-Lam', 'Ka-Man', 'Pui-Sze', 'Lok-Yee', 'Sze-Wing', 'Ka-Po', 'Mei-Ling', 'Yee-Ting'];
                const districts = ['Central & Western', 'Wan Chai', 'Eastern', 'Southern', 'Yau Tsim Mong', 'Sham Shui Po', 'Kowloon City', 'Wong Tai Sin', 'Kwun Tong', 'Kwai Tsing', 'Tsuen Wan', 'Tuen Mun', 'Yuen Long', 'North', 'Tai Po', 'Sha Tin', 'Sai Kung', 'Islands'];
                const classes = ['4A', '4C', '4D', '5D'];

                // Insert Students
                let studentInserts = [];
                const studentIds = [];
                const usedStudentIds = new Set();

                // Generate 120 students
                for (const className of classes) {
                    for (let i = 1; i <= 30; i++) {
                        let studentId;
                        do {
                            studentId = Math.floor(1000 + Math.random() * 9000);
                        } while (usedStudentIds.has(studentId));
                        usedStudentIds.add(studentId);
                        studentIds.push(studentId);
                        
                        const gender = Math.random() > 0.5 ? 'M' : 'F';
                        const firstName = gender === 'M' ? maleFirstNames[Math.floor(Math.random() * maleFirstNames.length)] : femaleFirstNames[Math.floor(Math.random() * femaleFirstNames.length)];
                        const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                        
                        // Randomly assign birth year: 2007, 2008, 2009, or 2010
                        const years = [2007, 2008, 2009, 2010];
                        const year = years[Math.floor(Math.random() * years.length)];
                        
                        const month = String(Math.floor(Math.random() * 12) + 1).padStart(2, '0');
                        const day = String(Math.floor(Math.random() * 28) + 1).padStart(2, '0');
                        const dob = `${year}-${month}-${day}`;
                        const district = districts[Math.floor(Math.random() * districts.length)];
                        studentInserts.push(`(${studentId}, '${className}', ${i}, '${lastName}', '${firstName}', '${gender}', '${dob}', '${district}')`);
                    }
                }
                database.run(`INSERT INTO students (student_id, class, no, last_name, first_name, gender, dob, district) VALUES ${studentInserts.join(', ')};`);
                
                // Insert Subjects
                const subjectMap = {
                    'Chinese': 'CHI',
                    'English': 'ENG',
                    'Math': 'MATH',
                    'ICT': 'ICT',
                    'Physics': 'PHY',
                    'Bio': 'BIO',
                    'Econ': 'ECON'
                };
                
                const subjectInserts = Object.entries(subjectMap).map(([name, code]) => `('${code}', '${name}')`);
                database.run(`INSERT INTO subjects (subject_code, subject_name) VALUES ${subjectInserts.join(', ')};`);

                // Generate Exam Results
                const mandatorySubjects = ['Chinese', 'English', 'Math'];
                const electiveSubjects = ['ICT', 'Physics', 'Bio', 'Econ'];
                let examInserts = [];
                
                for (const sId of studentIds) {
                    // Mandatory subjects
                    mandatorySubjects.forEach(subject => {
                        const score = Math.floor(Math.random() * 61) + 40; // 40-100
                        const code = subjectMap[subject];
                        examInserts.push(`(${sId}, '${code}', ${score})`);
                    });

                    // Elective subjects
                    const numElectives = Math.random() > 0.5 ? 3 : 2;
                    const shuffledElectives = [...electiveSubjects].sort(() => 0.5 - Math.random());
                    const takenElectives = shuffledElectives.slice(0, numElectives);
                    
                    takenElectives.forEach(subject => {
                        const score = Math.floor(Math.random() * 61) + 40; // 40-100
                        const code = subjectMap[subject];
                        examInserts.push(`(${sId}, '${code}', ${score})`);
                    });
                }
                database.run(`INSERT INTO exams (student_id, subject_code, score) VALUES ${examInserts.join(', ')};`);

            } catch (err) {
                console.error("Error creating sample tables:", err);
                displayMessage("error", "Could not create the initial sample tables.");
            }
        }

        function saveDatabase() {
            if (!db) return;
            try {
                const data = db.export();
                localStorage.setItem(dbKey, Array.from(data).toString());
                displayMessage("success", "Database saved successfully to this browser.");
            } catch (err) {
                console.error("Error saving database:", err);
                displayMessage("error", "Failed to save the database.");
            }
        }
        
        function resetDatabase() {
            // No confirmation for faster classroom use
            localStorage.removeItem(dbKey);
            createNewDatabase();
            updateTablesList();
        }

        // --- SQL Execution & Display ---
        function runSql() {
            if (!db) { displayMessage("error", "Database not loaded."); return; }
            const sqlCode = sqlEditor.value;
            clearResults();
            try {
                const statements = sqlCode.split(';').filter(s => s.trim() !== '');
                statements.forEach(statement => {
                     const results = db.exec(statement.trim());
                     results.forEach((result) => displayTable(result));
                });
                displayMessage("success", "Query executed successfully.");
                updateTablesList();
            } catch (err) {
                displayMessage("error", `Error: ${err.message}`);
            }
        }
        
        function updateTablesList() {
             if (!db) return;
             tablesList.innerHTML = '';
             try {
                const res = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%';");
                if (res.length > 0 && res[0].values.length > 0) {
                    res[0].values.forEach(row => {
                        const li = document.createElement('li');
                        li.textContent = row[0];
                        li.className = 'px-3 py-2 bg-slate-100 rounded-md cursor-pointer hover:bg-sky-100';
                        li.onclick = () => { sqlEditor.value = `SELECT * FROM ${row[0]};`; runSql(); };
                        tablesList.appendChild(li);
                    });
                } else {
                    tablesList.innerHTML = '<li class="text-slate-500 italic">No tables found.</li>';
                }
             } catch (e) { console.error(e); }
        }

        function displayTable(result) {
            if (!result || (result.values.length === 0 && result.columns.length === 0)) return;
            const table = document.createElement('table');
            table.className = "w-full text-sm text-left text-slate-500 border-collapse mb-4";
            const thead = document.createElement('thead');
            thead.className = "text-xs text-slate-700 uppercase bg-slate-100";
            const headerRow = document.createElement('tr');
            result.columns.forEach(colName => {
                const th = document.createElement('th');
                th.className = "px-4 py-3 border border-slate-200";
                th.textContent = colName;
                headerRow.appendChild(th);
});
            thead.appendChild(headerRow);
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            result.values.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-slate-50";
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.className = "px-4 py-2 border border-slate-200";
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            resultsContainer.appendChild(table);
        }

        function displayMessage(type, text) {
            messageArea.textContent = text;
            messageArea.className = 'mb-2 text-sm h-5 ';
            switch(type) {
                case "success": messageArea.classList.add('text-green-600'); break;
                case "error": messageArea.classList.add('text-red-600'); break;
                case "warning": messageArea.classList.add('text-amber-600'); break;
            }
        }
        function clearResults() { resultsContainer.innerHTML = ''; messageArea.innerHTML = ''; }

        // --- Event Listeners ---
        function setupQuestionListeners() {
            document.querySelectorAll('.question-list li').forEach(item => {
                item.addEventListener('click', event => {
                    const sql = event.target.getAttribute('data-sql');
                    sqlEditor.value = `${sql}\n\n`;
                    sqlEditor.focus();
                });
            });
        }
        
        runSqlBtn.addEventListener('click', runSql);
        saveDbBtn.addEventListener('click', saveDatabase);
        resetDbBtn.addEventListener('click', resetDatabase);
        sqlEditor.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                runSql();
            }
        });

        // Start the application
        main();
    </script>
</body>
</html>
